let selfUser,userMail,otherUser,currentChatRoom,chatArea=$("#chatbox"),roomList=[];var socket=io.connect("http://localhost:3001",{transports:["websocket"]});function joinRoom(){socket.emit("join_room",{user_email:userMail,chatroom:currentChatRoom}),socket.on("user_joined",(function(e){console.log("New User Joined")}))}socket.on("connect",(function(){console.log("connection established using sockets...!")}));var sendMessage=()=>{};function connectRoom(){roomList.includes(currentChatRoom)||(joinRoom(),roomList.push(currentChatRoom)),sendMessage()}function createArea(e,a,t){return`\n        \x3c!-- Chat toast START --\x3e\n        <div id="chatToast-${a._id}" class="toast mb-0 bg-mode" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">\n          <div class="toast-header bg-mode">\n            \x3c!-- Top avatar and status START --\x3e\n            <div class="d-flex justify-content-between align-items-center w-100">\n              <div class="d-flex">\n                <div class="flex-shrink-0 avatar me-2">\n                  <img class="avatar-img rounded-circle" src="${a.avatar?a.avatar:"/images/default-avatar.png"}" alt="">\n                </div>\n                <div class="flex-grow-1">\n                  <h6 class="mb-0 mt-1">${a.name}</h6>\n                  <div class="small text-secondary"><i class="fa-solid fa-circle text-success me-1"></i>Online</div>\n                </div>\n              </div>\n              <div class="d-flex">\n                \x3c!-- Call button --\x3e\n                <div class="dropdown">\n                  <a class="btn btn-secondary-soft-hover py-1 px-2" href="#" id="chatcoversationDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false"><i class="fa-solid fa-ellipsis-vertical"></i></a>\n                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatcoversationDropdown">\n                    <li><a class="dropdown-item" href="#"><i class="fa-solid fa-video me-2 fw-icon"></i>Video call</a></li>\n                    <li><a class="dropdown-item" href="#"><i class="fa-solid fa-phone me-2 fw-icon"></i>Call</a></li>\n                    <li><a class="dropdown-item" href="#"><i class="fa-solid fa-trash me-2 fw-icon"></i>Delete </a></li>\n                    <li><a class="dropdown-item" href="#"><i class="fa fa-fw fa-star me-2 fw-icon"></i>Mark as important</a></li>\n                    <li class="dropdown-divider"></li>\n                    <li><a class="dropdown-item" href="#"><i class="fa fa-ban me-2 fw-icon"></i>Block</a></li>\n                  </ul>\n                </div>\n                \x3c!-- Card action END --\x3e\n                <a class="btn btn-secondary-soft-hover py-1 px-2" data-bs-toggle="collapse" href="#collapseChat" aria-expanded="false" aria-controls="collapseChat"><i class="fa fa-minus"></i></a>\n                <button class="btn btn-secondary-soft-hover py-1 px-2" data-bs-dismiss="toast" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>\n              </div>\n            </div>\n            \x3c!-- Top avatar and status END --\x3e\n\n          </div>\n          <div class="toast-body collapse show position-relative" id="collapseChat">\n          <div class="spinner-container d-none">\n            <div class="spinner-border text-primary" role="status">\n              <span class="sr-only">Loading...</span>\n            </div>\n          </div>\n            \x3c!-- Chat conversation START --\x3e\n            <div class="chat-conversation-content custom-scrollbar mb-2 pe-2">\n              <div class="os-content" style="padding: 0px; height: 100%; width: 100%;"  id="chat-messages-list-${e._id}">\n                \x3c!-- Chat time --\x3e\n                <div class="text-center small my-2">Jul 16, 2022, 06:15 am</div>\n                ${e.messages.map((e=>""+(e.user!==t._id?`\x3c!-- Chat message left --\x3e\n                <div class="d-flex mb-1">\n                  <div class="flex-shrink-0 avatar avatar-xs me-2">\n                    <img class="avatar-img rounded-circle" src="${a.avatar?a.avatar:"/images/default-avatar.png"}" alt="">\n                  </div>\n                  <div class="flex-grow-1">\n                    <div class="w-100">\n                      <div class="d-flex flex-column align-items-start">\n                        <div class="bg-light text-secondary p-2 px-3 rounded-2">${e.message}</div>\n                        <div class="small my-2">${new Date(e.createdAt).toLocaleTimeString().split(":")[0]+":"+new Date(e.createdAt).toLocaleTimeString().split(":")[1]+" "+new Date(e.createdAt).toLocaleTimeString().split(" ")[1]} </div>\n                        \n                      </div>\n                    </div>\n                  </div>\n                </div>`:` \x3c!-- Chat message right --\x3e\n                <div class="d-flex justify-content-end text-end mb-1">\n                  <div class="w-100">\n                    <div class="d-flex flex-column align-items-end">\n                      <div class="bg-primary text-white p-2 px-3 rounded-2">${e.message}</div>\n                      \x3c!-- Images --\x3e\n                      <div class="d-flex my-2">\n                        <div class="small text-secondary">${new Date(e.createdAt).toLocaleTimeString().split(":")[0]+":"+new Date(e.createdAt).toLocaleTimeString().split(":")[1]+" "+new Date(e.createdAt).toLocaleTimeString().split(" ")[1]} </div>\n                        <div class="small ms-2"><i class="fa-solid fa-check"></i></div>\n                      </div>\n                    </div>\n                  </div>\n                </div>`))).join("")}\n                \x3c!-- Chat Typing \n                <div class="d-flex mb-1">\n                  <div class="flex-shrink-0 avatar avatar-xs me-2">\n                    <img class="avatar-img rounded-circle" src="${a.avatar?a.avatar:"/images/default-avatar.png"}" alt="">\n                  </div>\n                  <div class="flex-grow-1">\n                    <div class="w-100">\n                      <div class="d-flex flex-column align-items-start">\n                        <div class="bg-light text-secondary p-3 rounded-2">\n                          <div class="typing d-flex align-items-center">\n                            <div class="dot"></div>\n                            <div class="dot"></div>\n                            <div class="dot"></div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div> --\x3e\n              </div> \n\n            </div>\n            \x3c!-- Chat conversation END --\x3e\n            \x3c!-- Chat bottom START --\x3e\n            <div class="">\n              \x3c!-- Chat textarea --\x3e\n              <textarea class="form-control mb-sm-0 mb-3" id="chat-input-${e._id}" placeholder="Type a message" rows="1"></textarea>\n              \x3c!-- Button --\x3e\n\n            </div>\n            \x3c!-- Chat bottom START --\x3e\n          </div>\n        </div>\n        \x3c!-- Chat toast END --\x3e\n      `}function minimize(){$(".chatbox").toggleClass("chatbox-min")}function hide(){$("#chatbox").css("display","none"),$(".chatbox").hide()}function arrow(){$(".back-button").click((()=>{$("#chatbox").css("display","none"),$("#chatbox").css({display:"block",width:"100%"})}))}function changeScreen(){window.innerWidth<=430&&($("#chatbox").css({display:"block",width:"100%"}),$("#chatbox").css("display","none"))}function scrollBottom(){let e=document.getElementsByClassName("chat-conversation-content")[0];e.scrollTop=e.scrollHeight}function tempClass(e){$("#roomlist > div").removeClass("temporary-highlight"),$(`#friend-${e}`).addClass("temporary-highlight")}socket.on("receive_message",(function(e){let a=new Date(e.timestamp).toLocaleTimeString().split(":")[0]+":"+new Date(e.timestamp).toLocaleTimeString().split(":")[1]+" "+new Date(e.timestamp).toLocaleTimeString().split(" ")[1],t=$(`#chat-messages-list-${e.chatroom}`);e.user_email===userMail?t.append(`\n    <div class="d-flex justify-content-end text-end mb-1">\n      <div class="w-100">\n        <div class="d-flex flex-column align-items-end">\n          <div class="bg-primary text-white p-2 px-3 rounded-2">${e.message}</div>\n          \x3c!-- Images --\x3e\n          <div class="d-flex my-2">\n            <div class="small text-secondary">${a}</div>\n            <div class="small ms-2"><i class="fa-solid fa-check"></i></div>\n          </div>\n        </div>\n      </div>\n    </div>`):t.append(`<div class="d-flex mb-1">\n          <div class="flex-shrink-0 avatar avatar-xs me-2">\n            <img class="avatar-img rounded-circle" src="${e.user.avatar?e.user.avatar:"/images/default-avatar.png"}" alt="">\n          </div>\n          <div class="flex-grow-1">\n            <div class="w-100">\n              <div class="d-flex flex-column align-items-start">\n                <div class="bg-light text-secondary p-2 px-3 rounded-2">${e.message}</div>\n                <div class="small my-2">${a}</div>\n              </div>\n            </div>\n          </div>\n        </div>\n    `),scrollBottom()})),$(".toast-btn").each((function(){$(this).click((function(){let e=this;const a=$(this).attr("data-friend-id");if($(`#chatToast-${a}`).length){var t=document.getElementById(`chatToast-${a}`);new bootstrap.Toast(t).show(),$(`#chatToast-${a}  textarea`).focus(),tinymce.init({selector:`#chatToast-${a}  textarea`,menubar:!1,toolbar_location:"bottom",plugins:"autoresize link lists emoticons image",autoresize_bottom_margin:0,max_height:100,placeholder:"Enter message . . .",toolbar:"bold italic link bullist emoticons strikethrough | mySendButton",setup:function(e){e.ui.registry.addButton("mySendButton",{tooltip:"Send Message",text:"Send",onAction:function(){let a=e.getContent();""!=a&&"<p></p>"!=a&&(socket.emit("send_message",{message:a,user:selfUser,user_email:userMail,user_id:selfUser._id,chatroom:currentChatRoom}),e.setContent(""))}})}})}else $.ajax({type:"GET",url:`/messages/chatroom?friend=${a}`,success:function(a){let{chatRoom:t,friend:s,user:n}=a.data;$(".toast-container").empty(),tinymce.remove();let i=createArea(t,s,n);$(".toast-container").append(i),$(".spinner-container").removeClass("d-none"),setTimeout((()=>{$(".spinner-container").addClass("d-none")}),1e3);var o=document.getElementById(e.dataset.target);new bootstrap.Toast(o).show(),selfUser=n,otherUser=s,currentChatRoom=t._id,userMail=n.email,tinymce.init({selector:`#chat-input-${currentChatRoom}`,menubar:!1,toolbar_location:"bottom",plugins:"autoresize link lists emoticons image",autoresize_bottom_margin:0,max_height:100,placeholder:"Enter message . . .",toolbar:"bold italic link bullist emoticons strikethrough | mySendButton",setup:function(e){e.ui.registry.addButton("mySendButton",{tooltip:"Send Message",text:"Send",onAction:function(){let a=e.getContent();""!=a&&"<p></p>"!=a&&(socket.emit("send_message",{message:a,user:selfUser,user_email:userMail,user_id:selfUser._id,chatroom:currentChatRoom}),e.setContent(""))}})}}),connectRoom(),scrollBottom()},error:function(e){console.log(e.responseText)}})}))}));